<%#
  Edit Round End Date Page
  Admin/referee page to modify the round end date.
  Admins can select a club first; referees see their own club.
  Accessed from navbar dropdown menu.

  Features:
  - Club selection (admin only)
  - Display current round information and end date
  - Allow setting a new end date (minimum: start date + 1 month)
  - Warning if next round exists
%>
<div class="<%= class_names("text-size", "container": !@is_mobile) %>">
  <%# Authorization Check: Only admins, referees, and player referees can access %>
  <% unless (["admin", "referee", "player referee"].include?(current_user.role)) %>
    <br><br><%= t 'not_authorised' %>
  <% else %>
    <% if !@is_mobile %><br><% end %>

    <%# Page Header %>
    <h3><%= t '.round_end_title' %></h3>
    <h5><%= t '.change_end_date' %></h5>

    <div class="frame-color-shape frame-padding frame-margin-rl">
      <%# Club Selection: Admin must select a club first %>
      <% if current_user == @admin && !params[:club]%>
        <%= form_with url: edit_round_path, method: :get do |form| %>
          <div class="row">
            <div class="col-1"></div>
            <div class="col-3"><%= form.label :club, t('.select_club') %></div>
            <div class="col-5">
              <%# Club Dropdown: Auto-submits on change %>
              <%= form.select(:club, params[:club] ? @clubs : @clubs.unshift(t(".club")),
                             {selected: params[:club] ? params[:club] : t(".club")},
                             {onchange: "this.form.submit();"}) %>
            </div>
          </div>
        <% end %>
      <% elsif params[:club] || (["referee", "player referee"].include?(current_user.role)) %>
        <%# Club Display: Show club name for referees or when club is selected %>
        <div class="row">
          <div class="col-1"></div>
          <h4 class="col-7">
            <%= params[:club] %>
          </h4>
        </div>
        <%# Set club parameter for referees (uses their own club) %>
        <% params[:club] = current_user.club.name %>
      <% end %>

      <%# Round Edit Form: Only show if club is selected %>
      <% if params[:club] %>
        <div class="row">
        <br><br>

        <%# Round Information: Display round label with popover showing last match date %>
        <div class="row" data-controller="popover" data-bs-html="true" data-bs-toggle="popover"
          data-bs-trigger="hover" data-bs-placement="right" data-bs-delay= '{ "show": 500 }'
           data-bs-content="<%= t('.last_round_match_date', date: @last_round_match_date.strftime('%d/%m/%Y')) %>">
          <div class="col-1"></div>
          <%# Round Label: Display in RYY_NN format (e.g., R24_01) %>
          <div class="col-4">Round R<%= round_label(@round) %></div>
        </div>

        <%# Current End Date Display %>
        <div class="row">
          <div class="col-2"></div>
          <div class="col-3"><i><%= t '.current_end_date' %></i></div>
          <div class="col-2"><i><%= @round.end_date.strftime('%d/%m/%Y') %></i></div>
        </div>

        <%# Edit Round Form: Update end date %>
        <%= form_with model: @round do |form| %>
          <%# New End Date Input: Minimum value is start date + 1 month %>
          <div class="row">
            <div class="col-2"></div>
            <div class="col-3"><%= form.label :end_date, t('.new_end_date') %></div>
            <div class="col-2">
              <%= form.date_field(:end_date, min: @round.start_date >> 1) %>
            </div>
          </div>

          <%# Next Round Warning: Display if a next round exists %>
          <% if @next_round %>
            <div class="row">
              <div class="col-1"></div>
              <div class="col-4"><%= t '.next_round' %></div>
              <div class="col-5"><%= @next_round.start_date.strftime('%d/%m/%Y') %></div>
            </div>
            <div class="row">
              <div class="col-1"></div>
              <%= t '.message' %>
            </div>
          <% end %>

          <br>

          <%# Form Actions: Submit to update or go back %>
          <div class="one-liner">
            <%= form.submit t('.confirm_btn'), class: "btn btn-shape btn-green", name: "" %>
            &nbsp;&nbsp;&nbsp;&nbsp;
            <%= link_to t('.back_btn'), boxes_path(round_id: @round.id, club_id: @round.club_id), class: "btn btn-shape btn-yellow" %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>
</div>
