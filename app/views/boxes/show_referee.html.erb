<!-- admin/referee show page by list of matches, allows to edit, delete score, input new score (admin only) -->
<div class="container">
  <% if current_user.role == "player" %>
    <br><br><%= t '.not_authorised' %>
  <% else %>
    <%= render "intro_lines", box: @box, view_type: t("boxes.referee_view") %>

    <!---<div class = "frame-shape frame-padding text-size">-->
    <div class = "frame-shape frame-padding">
      <div class="same-line font-bold top-bottom-padding sticky-header">
        <div class="col-4"></div>
        <div class="col-2"><%= t '.match_score_header' %></div>
        <div class="col-2"><%= t '.player_points_header' %></div>
        <div class="col-2 color-tennis-blue"><%= t '.opponent_points_header' %></div>
        <div class="col-2 color-tennis-blue"><%= t '.opponent_total_points_header' %></div>
      </div>
      <ul>
        <% sorted_players = @box_matches.map { |bm| bm[2]} %>
        <% @box_matches.each do |user_box_matches| %>
          <li>
            <% user_box_score = user_box_matches[0] %>
            <% player = user_box_matches[2] %>
            <div class="top-bottom-padding">
              <%= render "shared/fullname", user: player %><%= "(# #{user_box_score.rank})" %> : <%= t("points", count: user_box_score.points) %>
            </div>
            <ul>
              <% player_matches = user_box_matches[1] %>
              <% sorted_players.each do |player_opponent| %>
                <% player_match = player_matches.select { |pm| pm[1] == player_opponent }[0] %>
                  <% if player_match %>
                    <% match = player_match[0] %>
                    <% opponent = player_match[1] %>
                    <% user_score = player_match[2] %>
                    <% opponent_score = player_match[3] %>
                    <% if match %>
                      <li>
                        <% name = "Score" %>
                        <% score_input_by = User.find(user_score.input_user_id) %>
                        <% input_date = @tz.to_local(user_score.input_date) %>
                        <% message = "#{t(".pop01", user: "#{score_input_by.role} #{render "shared/fullname", user: score_input_by}",
                                                    date: l(input_date, format: :wwwddmmmyy_at_hhmm))}" %>
                        <div data-controller="popover" data-bs-html="true" data-bs-toggle="popover"
                            data-bs-trigger="hover" data-bs-placement="bottom" data-html="true" data-bs-delay= '{ "show": 500 }'
                            data-bs-content="<%= message %>">
                          <div class="same-line player-name">
                            <div class="col-4">
                              <% match_time = @tz.to_local(match.time) %>
                              <%= "#{user_score.is_winner ? t(".won") : t(".lost")} #{t(".on_date")} #{l(match_time, format: :wwwddmmm_date)}" %>
                              <span class="color-tennis-blue">
                                <i>vs</i>
                                <%= render "shared/fullname", user: opponent %>
                                <%= "(# #{user_box_score.box.user_box_scores.find_by(user_id: opponent.id).rank})" %>
                              </span>
                            </div>
                            <div class="col-2"><%= render "shared/score", user_score: user_score, opponent_score: opponent_score %></div>
                            <div class="col-2"><%= t("pts", count: user_score.points) %></div>
                            <div class="col-2 color-tennis-blue"><%= t("pts", count: opponent_score.points) %></div>
                            <div class="col-2 color-tennis-blue"><%= t("pts", count: user_box_score.box.user_box_scores.find_by(user_id: opponent.id).points) %></div>
                            <!-- click on player line to update/delete match and user_match_scores details -->
                            <%= link_to '', edit_match_path(match_id: match.id), class: "line-link" %>
                          </div>
                        </div>
                      </li>
                    <% end %>
                  <% elsif player_opponent != player%>
                    <li><div class="same-line player-name color-tennis-blue">
                      <div class="col-4"><%= render "shared/fullname", user: player_opponent %></div>
                      <div class="col-2"><%= t '.not_played' %></div>
                      <% if current_user == @admin %>
                        <% message = "#{t(".pop02_a")}#{render "shared/fullname", user: player}<i>vs</i><br />#{render "shared/fullname", user: player_opponent}" %>
                        <div data-controller="popover" data-bs-html="true" data-bs-toggle="popover"
                            data-bs-trigger="hover" data-bs-placement="bottom" data-html="true" data-bs-delay= '{ "show": 500 }'
                            data-bs-content="<%= message %>">
                          <!-- click on opponent line to enter new match score -->
                          <%= link_to '', new_match_path(round_id: @box.round.id, opponent_id: player_opponent.id, player_id: player.id), class: "line-link" %>
                        </div>
                      <% end %>
                    </div></li>
                  <% end %>
              <% end %>
            </ul>
          </li>
        <% end %>
      </ul>
    </div><br>
  <% end %>
  <br>
  <!---
  <div class="buttons-wrap dont-print">
    <% if @page_from %>
      <% parameters = "?round_start=#{@box.round.start_date}&club_name=#{@box.round.club.name}" %>
      <%= link_to t("back_btn"), @page_from+parameters, class: "btn buttons-shape btn-blue" %>
    <% else %>
      <%# link_to "Back", "javascript:history.back()", class: "btn buttons-shape btn-blue" %>
      <%= link_to t("back_btn"), :back, class: "btn buttons-shape btn-blue" %>
    <% end %>
  </div>
  --->
</div>
