<%#
  Grid View Partial
  Displays a box in grid/table format showing all matches between players.
  Structure:
    - First column (col-2): Box number header and player names with points/rank
    - Remaining columns (col-10): Column headers (opponent names) and match cells
  Each cell shows either a played match (with score) or an unplayed match (with "Enter score" link).
%>
<div class = "<%=class_names( "box-table-wrap", "frame-color-shape frame-padding": !clear_format ) %>">
  <div class="<%=class_names( "row small-font",
                              "mobile-box-table-width mobile-grid-container mobile-text-size": @is_mobile,
                              "box-width grid-container": !@is_mobile) %>">

    <%# First Column (2/12 width): Box header and player labels %>
    <div class="col-2 print-all-content">
      <%# Top Left Corner: Box Number Header %>
      <% if page_from == box_path(box) %>
        <%# Single box grid view: static box number display %>
        <div class="row mb-3">
          <div class="<%=class_names( "col-12 bold-font", "color-tennis-red": is_this_my_box, "color-tennis-blue": !is_this_my_box) %>">
            <h5><%= "Box #{box.box_number}".upcase %></h5>
          </div>
        </div>
      <% else %>
        <%# All boxes grid view: clickable box number with popover %>
        <div class="row mb-3" data-controller="popover" data-bs-html="true" data-bs-toggle="popover"
                data-bs-trigger="hover" data-bs-placement="right" data-bs-content="Box <%= box.box_number %> : <%= t '.message_box_pop' %>">
          <div class="col-12 bold-font">
            <% classe = class_names("click-cell", "color-tennis-red": is_this_my_box, "color-tennis-blue": !is_this_my_box) %>
            <%= link_to "Box #{box.box_number}".upcase, box_list_path(box), page_from: index_expanded_path, class: classe %>
          </div>
        </div>
      <% end %>

      <%# First Column Rows: Player names, points, and rank %>
      <%# Extract sorted list of players for consistent ordering %>
      <% sorted_players = box_matches.map { |x| x[2]} %>
      <% box_matches.each do |user_box_matches| %>
        <div class="row first-col-lines">
          <div class="col-12">
            <% user_box_score = user_box_matches[0] %>
            <% line_player = user_box_score.user %>
            <%# Build popover content with player contact info %>
            <% name = "#{render "shared/fullname", user: line_player}" %>
            <% message = "ğŸ“ #{line_player.phone_number}<br />âœ‰ï¸#{line_player.email}" %>
            <div data-controller="popover" data-bs-html="true" data-bs-toggle="popover"
            data-bs-trigger="hover" data-bs-placement="bottom" data-bs-delay= '{ "show": 500 }'
            title="<%= name %>" data-bs-content="<%= message %>">
              <%# Highlight current user's name in red %>
              <span class="<%=class_names("bold-font", "color-tennis-red": user_box_matches[0].user == current_user) %>">
                <%= render "shared/fullname", user: line_player %>
              </span><br>
              <%# Display points and rank %>
              <%= t("pts", count: user_box_score.points) %><%= " ##{user_box_score.rank} " %>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <%# Remaining Columns (10/12 width): Column headers and match grid %>
    <div class="col-10 print-all-content">
      <%# Column Headers: Opponent names %>
      <div class="row bold-font mb-3">
        <% box_matches.each do |user_box_matches| %>
          <div class="col-2 text-center">
            <% user_box_score = user_box_matches[0] %>
            <% column_player = user_box_score.user %>
            <%# Highlight current user's name in red %>
            <span class="<%=class_names( "color-tennis-red": user_box_matches[0].user == current_user) %>">
              <%= render "shared/fullname", user: column_player %>
            </span>
          </div>
        <% end %>
      </div>

      <%# Grid Lines: Match cells for each player combination %>
      <div id="grid-lines">
        <% box_matches.each do |user_box_matches|
          user_box_score = user_box_matches[0]
          player_matches = user_box_matches[1]
          line_player = user_box_matches[2] %>
          <div class="row">
            <%# Iterate through sorted players to maintain consistent column order %>
            <% sorted_players.each do |column_player| %>
              <%# Find match between line_player and column_player %>
              <%player_match = player_matches.select { |x| x[1] == column_player }[0] %>
              <div class="col-2 text-center grid-columns">
                <span class="align-middle">
                  <% if player_match %>
                    <%# Match played: render match cell with score %>
                    <%= render "match_cell", player_match: player_match, line_player: line_player, page_from: page_from %>
                  <% else %>
                    <%# No match: render empty cell with "Enter score" link (if authorized) %>
                    <%= render "no_match_cell", column_player: column_player, line_player: line_player, page_from: page_from, box: box %>
                  <% end %>
                </span>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
