<%#
  display (players), or chose and display (admin/referee) a chatroom.
  For each box, if not already created in Round/new (TO DO?), or in UserBoxScore/new (TO DO?),
  a chatroom is created in Box controller #my_scores.
-%>
<%
  is_admin_or_referee = ["admin", "referee", "player referee"].include?(current_user.role)
%>
<% if @chatroom %>
  <!-- coming from Box/my_scores or if chatroom chosen from the form -->
  <div class="<%= class_names("text-size", "container": !@is_mobile) %>"
    data-controller="chatroom-subscription"
    data-chatroom-subscription-chatroom-id-value="<%= @chatroom.id %>"
    data-chatroom-subscription-chatroom-name-value="<%= @chatroom.name %>"
  >
    <% if !@is_mobile %><br><% end %>
    <div class="one-liner" style="width: 100%">
      <h3><%= @chatroom.name == "general" ? "General Chatroom" : "Chatroom - Box #{@box_nb}" %></h3>
      <span class="will-print"><%= image_tag "box_league_racket.png", alt: "Tennis racket", width: 50 %> LeagueBox ¬©</span>
    </div>
    <h5  class="one-liner">
      #<%= t(".chatroom_title", chatroom: @chatroom.name) %>
      <div>
        <%# link_to t('.back_btn'), :back, class: "btn btn-shape btn-yellow dont-print" %>
        <%= link_to t('.back_btn'), is_admin_or_referee ? chatroom_path(0) : my_scores_path(0), class: "btn btn-shape btn-yellow dont-print" %>
        <%= link_to t('print_btn'), '#', onclick: 'window.print();return false;', class: "btn btn-shape btn-green dont-print"%>
      </div>
    </h5>
    <div class="frame-color-shape chatroom-frame">
      <%# Bulk delete form for admin %>
      <% if current_user == @admin %>
        <div class="dont-print mb-3">
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <button type="button" class="btn btn-shape btn-yellow" onclick="selectAllMessages()">
              <%= t(".select_all", default: "Select All") %>
            </button>
            <button type="button" class="btn btn-shape btn-yellow" onclick="deselectAllMessages()">
              <%= t(".deselect_all", default: "Deselect All") %>
            </button>
            <button type="button" class="btn btn-shape btn-orange" id="bulk-delete-btn" disabled onclick="submitBulkDelete()">
              <%= t(".bulk_delete", default: "Delete Selected") %>
            </button>
            <span id="selected-count" class="text-size"></span>
          </div>
        </div>
      <% end %>

      <!-- list of all previous messages in the chatroom -->
      <div class="messages print-all-content" data-chatroom-subscription-target="messages">
        <% @chatroom.messages.sort.each do |message| %>
          <%= render "messages/message", message: message %>
        <% end %>
      </div>

      <!-- new message form -->
      <%# click on the message text box for the legend to show %>
      <div class="dont-print" data-controller="popover" data-bs-html="true" data-bs-toggle="popover"
        data-bs-trigger="click" data-bs-placement="top" data-bs-delay= '{ "show": 500 }'
        data-bs-content="<%= t '.message' %>">
        <%= form_for [@chatroom, @message],
          html: { data: { action: "turbo:submit-end->chatroom-subscription#resetForm" }, class: "d-flex" } do |f| %>
          <%= f.text_field :content,
            label: false,
            placeholder: "#{t ".message_invite"} #{@chatroom.name[-10,200]}",
            class: "flex-grow-1 border-0 rounded-3"
          %>
          <%= f.submit t(".send_btn"), class: "btn btn-shape btn-beige ms-2" %>
        <% end %>
      </div>
    </div>
  </div>

  <%# JavaScript for bulk message selection (admin only) %>
  <% if current_user == @admin %>
    <div id="bulk-delete-data"
         data-bulk-delete-url="<%= bulk_delete_chatroom_messages_path(@chatroom) %>"
         data-selected-text="<%= t(".selected", default: "selected") %>"
         data-no-messages-text="<%= t(".no_messages_selected", default: "No messages selected") %>"
         data-confirm-text="<%= t(".confirm_bulk_delete", default: "Are you sure you want to delete the selected messages?") %>"
         style="display: none;"></div>
    <script>
      (function() {
        const dataEl = document.getElementById('bulk-delete-data');
        if (!dataEl) return;

        const bulkDeleteUrl = dataEl.dataset.bulkDeleteUrl;
        const selectedText = dataEl.dataset.selectedText;
        const noMessagesText = dataEl.dataset.noMessagesText;
        const confirmText = dataEl.dataset.confirmText;

        function updateSelectedCount() {
          const checkboxes = document.querySelectorAll('.message-checkbox-input:checked');
          const countElement = document.getElementById('selected-count');
          const deleteBtn = document.getElementById('bulk-delete-btn');
          const count = checkboxes.length;

          if (countElement) {
            countElement.textContent = count > 0 ? `(${count} ${selectedText})` : '';
          }

          if (deleteBtn) {
            deleteBtn.disabled = count === 0;
          }
        }

        window.selectAllMessages = function() {
          document.querySelectorAll('.message-checkbox-input').forEach(checkbox => {
            checkbox.checked = true;
          });
          updateSelectedCount();
        };

        window.deselectAllMessages = function() {
          document.querySelectorAll('.message-checkbox-input').forEach(checkbox => {
            checkbox.checked = false;
          });
          updateSelectedCount();
        };

        window.submitBulkDelete = function() {
          const checkboxes = document.querySelectorAll('.message-checkbox-input:checked');
          const messageIds = Array.from(checkboxes).map(cb => cb.value);

          if (messageIds.length === 0) {
            alert(noMessagesText);
            return;
          }

          if (!confirm(confirmText)) {
            return;
          }

          // Create a form and submit it
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = bulkDeleteUrl;

          // Add CSRF token
          const csrfToken = document.querySelector('meta[name="csrf-token"]');
          if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'authenticity_token';
            csrfInput.value = csrfToken.content;
            form.appendChild(csrfInput);
          }

          // Add method override for DELETE
          const methodInput = document.createElement('input');
          methodInput.type = 'hidden';
          methodInput.name = '_method';
          methodInput.value = 'delete';
          form.appendChild(methodInput);

          // Add message IDs
          messageIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'message_ids[]';
            input.value = id;
            form.appendChild(input);
          });

          document.body.appendChild(form);
          form.submit();
        };

        // Add event listeners to all checkboxes
        document.addEventListener('DOMContentLoaded', function() {
          document.querySelectorAll('.message-checkbox-input').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
          });
          updateSelectedCount();
        });

        // Also handle dynamically added messages (from ActionCable)
        const messagesContainer = document.querySelector('[data-chatroom-subscription-target="messages"]');
        if (messagesContainer) {
          const observer = new MutationObserver(function(mutations) {
            document.querySelectorAll('.message-checkbox-input').forEach(checkbox => {
              if (!checkbox.hasAttribute('data-listener-added')) {
                checkbox.addEventListener('change', updateSelectedCount);
                checkbox.setAttribute('data-listener-added', 'true');
              }
            });
          });
          observer.observe(messagesContainer, { childList: true, subtree: true });
        }
      })();
    </script>
  <% end %>
<% else %>
  <!-- select a chatroom from the forms -->
  <div class="<%= class_names("text-size", "container": !@is_mobile) %>">
    <% unless is_admin_or_referee %>
      <br><br><h4>üòê <%= t 'not_authorised' %> üòê</h4>
    <% else %>
      <% suffix = current_user.role.split.map(&:capitalize).join.underscore %>
      <br><h3><%= t(".chatrooms_title", club: current_user == @admin ? "" : current_user.club.name).strip.titleize %></h3>

      <%# Display unread chatrooms list %>
      <% if @unread_chatrooms&.any? %>
        <%
          # Filter and prepare chatrooms
          filtered_chatrooms = @unread_chatrooms.select { |c| c.users_with_access.include?(current_user) && (c.name == "general" || c.box) }

          # Group by club for admin, flat list for referees
          if current_user == @admin
            unread_by_club = filtered_chatrooms.group_by do |chatroom|
              chatroom.name == "general" ? "General" : chatroom.box.round.club.name
            end.sort_by { |club_name, _| club_name == "General" ? "0" : club_name }
          end
        %>
        <div class="frame-color-shape frame-padding frame-margin-rl text-size mb-3">
          <h5><%= t(".unread_chatrooms_title") %></h5>
          <% if current_user == @admin %>
            <%# Group by club for admin %>
            <% unread_by_club.each do |club_name, chatrooms| %>
              <div class="mb-3">
                <h6 class="mb-2"><strong><%= club_name %></strong></h6>
                <ul class="list-unstyled d-flex flex-wrap gap-2">
                  <% chatrooms.each do |chatroom| %>
                    <li>
                      <%= link_to chatroom.name, chatroom_path(chatroom), class: "btn btn-shape btn-beige" %>
                    </li>
                  <% end %>
                </ul>
              </div>
            <% end %>
          <% else %>
            <%# Display for referees %>
            <ul class="list-unstyled d-flex flex-wrap gap-2">
              <% filtered_chatrooms.each do |chatroom| %>
                <li>
                  <%= link_to chatroom.name, chatroom_path(chatroom), class: "btn btn-shape btn-beige" %>
                </li>
              <% end %>
            </ul>
          <% end %>
        </div>
      <% end %>

      <h5><%= t(".chatroom_choice") %> <%= "#{t('.message2_box_pop')} #{t(".message2_box_pop_#{suffix}")}" %></h5>
      <div class="frame-color-shape frame-padding frame-margin-rl text-size">
        <br>
        <%# form 1: choose an open chatroom from a list of chatroom names %>
        <div data-controller="popover" data-bs-html="true" data-bs-toggle="popover"
        data-bs-trigger="hover focus" data-bs-placement="bottom" data-html="true" data-bs-delay= '{ "show": 500 }'
        data-bs-content="<%= t '.message1_box_pop' %>">
          <%= t(".chose_chatroom") %>
          <%= form_with url: chatroom_path, method: :get do |form| %>
            <div class="row">
              <div class="col-1"></div>
              <div class="col-11"><%= form.select(:chatroom, @chatrooms.sort.unshift(t(".chatroom_name")), {selected: "chatroom"}, {onchange: "this.form.submit();"}) %></div>
              <%# form.submit t(".confirm_btn"), class: "btn btn-shape btn-green", name: "" %>
            </div>
          <% end %>
        </div>
        <br><b><%= t(".or") %>:</b><br><br>

        <%# form 2: select a club, a round and a box to open or create the corresponding chatroom %>
        <div data-controller="popover" data-bs-html="true" data-bs-toggle="popover"
        data-bs-trigger="hover focus" data-bs-placement="bottom" data-html="true" data-bs-delay= '{ "show": 500 }'
        data-bs-content="<%= "#{t('.message2_box_pop').capitalize} #{t(".message2_box_pop_#{suffix}")}" %>">
          <%= t(".new_chatroom") %><br>
          <% if current_user == @admin %>
            <%= form_with url: chatroom_path, method: :get do |form| %>
              <%# as some chatrooms are not open yet, select a club (admin) %>
              <div class="row">
                <div class="col-1"></div>
                <div class="col-11">
                  <%= form.select(:club, params[:club] ? @clubs : @clubs.unshift(t(".club")), {selected: params[:club] ? params[:club] : t(".club")}, {onchange: "this.form.submit();"}) %>
                </div>
              </div>
            <% end %>
          <% else %> <%# if current user is a referee or a player, a club is set %>
            <div class="row">
              <div class="col-1"></div>
              <div class="col-11">
                <%= current_user.club.name %>
              </div>
            </div>
            <% params[:club] = current_user.club.name %>
          <% end %>
          <% if params[:club] %>
            <% club_index = @data.index {|club| club[:name] == params[:club]}
              rounds = @data[club_index][:rounds].map{|round| round[:start_date]}.sort %>
            <%= form_with url: chatroom_path, method: :get do |form| %>
              <%# select a round in the selected club %>
              <div class="row">
                <div class="col-1"></div>
                <div class="col-11">
                  <% start_dates = rounds.map { |round_start_date| round_start_date.to_date.strftime('%d/%m/%Y') } %>
                  <%= form.select(:round, start_dates.unshift(t(".round")), {selected: params[:round] ? params[:round].to_date.strftime('%d/%m/%Y') : t(".round")}, {onchange: "this.form.submit();"}) %>
                  <% if params[:round] %>
                    <%# display round number in RYY_NN format %>
                    <% club = Club.find_by(name: params[:club])
                      round = Round.find_by(club_id: club.id, start_date: params[:round].to_date) %>
                    <%= "=> round R#{round_label(round)}" %>
                  <% end %>
                </div>
                <%= hidden_field_tag(:club, params[:club]) %>
              </div>
            <% end %>
          <% end %>
          <% if params[:round] %>
            <% club_index = @data.index {|club| club[:name] == params[:club]}
              round_index = @data[club_index][:rounds].index {|round| round[:start_date].to_date.strftime('%d/%m/%Y') == params[:round]}
              boxes = @data[club_index][:rounds][round_index][:boxes].map{|box| box[:box_number]}.sort %>
            <%= form_with url: chatroom_path, method: :get do |form| %>
              <%# select a box in the selected round %>
              <div class="row">
                <div class="col-1"></div>
                <div class="col-11">
                  <%= form.select(:box, boxes.unshift(t(".box")), {selected: t(".box")}, {onchange: "this.form.submit();"}) %>
                </div>
                <%= hidden_field_tag(:club, params[:club]) %>
                <%= hidden_field_tag(:round, params[:round]) %>
              </div>
            <% end %>
          <% end %>
        </div>
        <br>
      </div>

      <%# Delete chatroom form (admin only) %>
      <% if current_user == @admin %>
        <div class="frame-color-shape frame-padding frame-margin-rl text-size mb-3">
          <h5><%= t(".delete_chatroom_title", default: "Delete a chatroom") %></h5>
          <div data-controller="popover" data-bs-html="true" data-bs-toggle="popover"
          data-bs-trigger="hover focus" data-bs-placement="bottom" data-html="true" data-bs-delay= '{ "show": 500 }'
          data-bs-content="<%= t('.delete_chatroom_popover', default: "Select a chatroom to delete. This will permanently delete the chatroom and all its messages.") %>">
            <%= t(".select_chatroom_to_delete", default: "Select a chatroom to delete:") %>
            <%= form_with url: chatroom_path(0), method: :get, local: true do |form| %>
              <div class="row">
                <div class="col-1"></div>
                <div class="col-11">
                  <% deletable_chatrooms = @chatrooms.reject { |c| c == "#general" || c == "general" }.sort %>
                  <%= form.select(:delete_chatroom, deletable_chatrooms.unshift(t(".chatroom_name")), {selected: t(".chatroom_name")}, {onchange: "this.form.submit();"}) %>
                </div>
              </div>
            <% end %>
          </div>
          <% if params[:delete_chatroom] && params[:delete_chatroom] != t(".chatroom_name") %>
            <% selected_chatroom_name = params[:delete_chatroom][1..] # Remove '#' %>
            <% chatroom_to_delete = Chatroom.find_by(name: selected_chatroom_name) %>
            <% if chatroom_to_delete %>
              <div class="mt-3">
                <p><strong><%= t(".chatroom_to_delete", default: "Chatroom to delete:") %> <%= chatroom_to_delete.name %></strong></p>
                <p class="text-muted"><%= t(".messages_count", default: "Messages in this chatroom:") %> <%= chatroom_to_delete.messages.count %></p>
                <%= form_with url: chatroom_path(chatroom_to_delete), method: :delete, local: true do |form| %>
                  <%= form.submit t(".confirm_delete_chatroom", default: "Delete Chatroom and All Messages"),
                      class: "btn btn-shape btn-orange",
                      data: { confirm: t(".confirm_delete_chatroom_message", default: "Are you sure you want to delete this chatroom and all its messages? This action cannot be undone.") } %>
                <% end %>
              </div>
            <% end %>
          <% end %>
        </div>
      <% end %>

      <% if params[:club]
          club = Club.find_by(name: params[:club]) %>
        <div class="buttons-wrap">
          <%= link_to t('.back_btn'), user_box_scores_path(club_id: club.id), class: "btn btn-shape btn-yellow" %>
        </div>
      <% else %>
        <div class="buttons-wrap">
          <%= link_to t('.back_btn'), root_path, class: "btn btn-shape btn-yellow" %>
        </div>
      <% end %>
    <% end %>
  </div>
<% end %>
<br>
