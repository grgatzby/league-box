<%# My details form for existing user %>
<%= render "shared/image_front" %>
<div class="<%= class_names("container": !@is_mobile) %>">
  <div class="one-liner">
    <h3><%= t '.title' %></h3>
  </div>
  <%# Removed Active Storage photo code - now using CarrierWave on User model for profile pictures %>

  <%= form_with model: @preference, method: @preference.id ? :patch : :post, multipart: true do |preference_f| %>

    <div class="frame-color-shape frame-padding frame-margin-rl text-size box-scroller" >
      <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
        <% if current_user.profile_picture.present? %>
          <%= image_tag(profile_picture_circular_url(current_user, 40), alt: 'Profile picture', id: "top_profile_picture", style: "width: 40px; height: 40px; border-radius: 50%; object-fit: cover;") %>
        <% else %>
          <img id="top_profile_picture" alt="Profile picture" style="display: none; width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" />
        <% end %>
        <b><%= render "shared/fullname", user: current_user %></b>
      </div>
      <br><br>

      <%# Display-only information rows %>
      <%= render "preferences/display_row", emoji: "ðŸŽ¾", label: "Club", value: current_user.club.name.titleize %>
      <%= render "preferences/display_row", emoji: "ðŸ§©", label: t(".role"), value: current_user.role %>

      <%# Editable form fields %>
      <%= render "preferences/form_field",
          form: preference_f,
          field_name: :nickname,
          emoji: "ðŸ˜Ž",
          label_text: t(".nickname"),
          placeholder: current_user.nickname,
          field_value: current_user.nickname,
          width: "15em" %>
      <%= render "preferences/form_field",
          form: preference_f,
          field_name: :first_name,
          emoji: "ðŸ‘¤",
          label_text: t(".first_name"),
          placeholder: current_user.first_name,
          field_value: current_user.first_name,
          width: "15em" %>
      <%= render "preferences/form_field",
          form: preference_f,
          field_name: :last_name,
          emoji: "ðŸ‘¤",
          label_text: t(".last_name"),
          placeholder: current_user.last_name,
          field_value: current_user.last_name,
          width: "15em" %>
      <%= render "preferences/form_field",
          form: preference_f,
          field_name: :e_mail,
          emoji: "ðŸ“©",
          label_text: t(".e_mail"),
          placeholder: current_user.email,
          field_value: current_user.email,
          width: "20em" %>
      <%= render "preferences/form_field",
          form: preference_f,
          field_name: :phone_number,
          emoji: "ðŸ“ž",
          label_text: t(".phone_number"),
          placeholder: current_user.phone_number,
          field_value: current_user.phone_number,
          width: "10em" %>
     <hr>

      <div class="row">
        <div class="col-4"><%= label_tag "user[profile_picture]", t(".profile_picture") %></div>
        <div class="col-8">
          <div style="display: flex; align-items: center; gap: 15px;">
            <div class="custom-file-input-wrapper">
              <%= file_field_tag "user[profile_picture]", accept: "image/jpeg,image/jpg,image/png,image/gif,image/webp", class: "form-control custom-file-input", id: "profile_picture_input" %>
              <label for="profile_picture_input" class="custom-file-label btn btn-shape btn-beige">
                <%= t(".choose_file") %>
              </label>
            </div>
            <div id="profile_picture_preview">
              <% if current_user.profile_picture.present? %>
                <%= image_tag(current_user.profile_picture.url.to_s, alt: 'Profile picture', class: "rounded", style: "max-width: 100px; max-height: 100px;", id: "preview_image") %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
      <script>
        (function() {
          function initProfilePicturePreview() {
            const fileInput = document.getElementById('profile_picture_input');
            const previewContainer = document.getElementById('profile_picture_preview');
            const topProfilePicture = document.getElementById('top_profile_picture');

            if (!fileInput || !previewContainer) {
              console.warn('Profile picture preview elements not found');
              return;
            }

            fileInput.addEventListener('change', function(e) {
              if (e.target.files && e.target.files.length > 0) {
                const file = e.target.files[0];

                // Validate file type
                if (!file.type.match('image.*')) {
                  console.warn('Selected file is not an image');
                  return;
                }

                const reader = new FileReader();

                reader.onload = function(event) {
                  const imageUrl = event.target.result;

                  // Update top circular profile picture
                  if (topProfilePicture) {
                    topProfilePicture.src = imageUrl;
                    topProfilePicture.style.display = 'block';
                  }

                  // Update or create preview image
                  let previewImg = previewContainer.querySelector('img');
                  if (previewImg) {
                    previewImg.src = imageUrl;
                  } else {
                    previewImg = document.createElement('img');
                    previewImg.src = imageUrl;
                    previewImg.alt = 'Profile picture preview';
                    previewImg.className = 'rounded';
                    previewImg.style.cssText = 'max-width: 100px; max-height: 100px;';
                    previewContainer.insertBefore(previewImg, previewContainer.firstChild);

                    // Add line breaks for spacing if they don't exist
                    if (!previewContainer.querySelector('br')) {
                      const br1 = document.createElement('br');
                      const br2 = document.createElement('br');
                      previewContainer.appendChild(br1);
                      previewContainer.appendChild(br2);
                    }
                  }
                };

                reader.onerror = function() {
                  console.error('Error reading file');
                };

                reader.readAsDataURL(file);
              }
            });
          }

          // Run immediately if DOM is ready, otherwise wait for DOMContentLoaded
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initProfilePicturePreview);
          } else {
            // DOM is already loaded, run immediately
            initProfilePicturePreview();
          }
        })();
      </script>


      <div class="row">
        <div class="col-4"><%= preference_f.label :password, "ðŸ” #{t(".password")}:" %></div>
        <div class="col-8">
          <small><i><%= preference_f.label :password, t(".modify_password") %></i></small>
          &nbsp;&nbsp;<%= check_box_tag(:password,"1", params[:password].eql?("1")) %>
        </div>
      </div>

      <hr>
      <b><%= t(".preferences") %></b><br>
        <%# checkbox to remove color gradient formatting if page does not display well on screen %>
        <%# check_box_tag(:clear_format,"1", params[:clear_format].eql?("1"), onchange: "this.form.submit();") %>
      <div class="row">
        <div class="col-4"><%= t(".expanded_view") %></div>
        <div class="col-8">
          <small><i><%= preference_f.label :clear_format, t(".clear_format") %></i></small>
          &nbsp;&nbsp;<%= check_box_tag(:clear_format,"1", @preference.clear_format.eql?(true)) %>
        </div>
      </div>

      <% if (["player", "player referee"].include?(current_user.role)) %>
        <hr>
        <b><%= t(".history") %></b><br>
        <div class="row">
          <div class="col-4">
            <%= t(".previous_rounds") %>
          </div>
          <div class="col-8">
            <i><%= "League_Round - Box, #rank" %></i><br>
            <% name = "#{render "shared/fullname", user: current_user}"
              boxes = current_user.user_box_scores.map{ |ubs| "#{round_label(ubs.box.round)} - Box#{format('%02d', ubs.box.box_number)}, ##{ubs.rank},<br />" }.sort.join[0...-7] %>
            <%= sanitize "#{boxes}" %>
          </div>
        </div>
      <% end %>

      <%# My Club Section: Allow admin/referee to edit club website %>
      <% if current_user && (current_user.role&.include?("referee") || current_user == @admin) %>
        <hr>
        <div class="row">
          <div class="col-4"><b><%= t(".club_details") %></b></div>
          <small class="col-8"><i><%= t(".website_note_html", inset: "<a class='btn btn-inlayed bold-font color-blue' href='#{my_club_path}'>#{t ".website_note_club"}</a>".html_safe) %></i></small>
        </div>
        <% if current_user == @admin %>
          <% available_clubs = Club.all.reject { |c| c == @sample_club } %>
          <% selected_club_id = if params[:club_id].present?
                                   params[:club_id].to_i
                                 elsif available_clubs.any?
                                   available_clubs.first.id
                                 else
                                   current_user.club.id
                                 end %>
          <% selected_club = Club.find(selected_club_id) %>
          <%# Admin club selection dropdown (not a separate form, just updates the hidden field) %>
          <div class="row mb-3">
            <div class="col-4"><%= label_tag :club_id, t(".select_club"), class: "form-label" %></div>
            <div class="col-8">
              <%= select_tag :club_id,
                  options_for_select(available_clubs.map { |club| [club.name, club.id] }, selected_club_id),
                  { class: "form-control", id: "club_select_dropdown", style: "width: 20em; max-width: 100%" } %>
            </div>
          </div>
          <%# Store club data for JavaScript (embedded in script tag) %>
          <script type="application/json" id="clubs-data">
            <%= available_clubs.map { |club| { id: club.id, website: club.website || "" } }.to_json.html_safe %>
          </script>
        <% else %>
          <%# Referee can only edit their own club %>
          <% selected_club = current_user.club %>
        <% end %>

        <%# Website update field %>
        <div class="row">
          <div class="col-4"><%= preference_f.label :website, "ðŸŒ #{t(".website")}:", for: "website_input" %></div>
          <div class="col-8">
            <%= preference_f.text_field :website,
                placeholder: t(".website_placeholder"),
                value: selected_club.website,
                #style: "width: 100%; max-width: 30em",
                style: "width: 20em; max-width: 100%",
                class: "form-control",
                id: "website_input" %>
            <small class="form-text text-muted"><i><%= t(".website_help") %></i></small>
          </div>
        </div>

        <%# JavaScript to update website field when club dropdown changes (admin only) %>
        <% if current_user == @admin %>
          <script>
            (function() {
              const clubSelect = document.getElementById('club_select_dropdown');
              const websiteInput = document.getElementById('website_input');
              const websiteClubId = document.getElementById('website_club_id');
              const clubsDataElement = document.getElementById('clubs-data');

              if (!clubSelect || !websiteInput || !websiteClubId || !clubsDataElement) {
                return;
              }

              const clubsData = JSON.parse(clubsDataElement.textContent || '[]');

              clubSelect.addEventListener('change', function() {
                const selectedClubId = parseInt(this.value);
                const selectedClub = clubsData.find(club => club.id === selectedClubId);

                if (selectedClub) {
                  websiteInput.value = selectedClub.website || '';
                  websiteClubId.value = selectedClubId;
                }
              });
            })();
          </script>
        <% end %>
        <%# Hidden field for club_id (top-level parameter, not nested under preference) %>
        <%= hidden_field_tag :club_id, selected_club.id, id: "website_club_id" %>
      <% end %>
    </div>
    <br>
    <div class = "buttons-wrap">
      <%= preference_f.submit t(".submit_button"), class: "btn btn-shape btn-aqua" %>
    </div>
  <% end %>

</div>
