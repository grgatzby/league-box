<%# My details form for existing user %>
<%= render "shared/image_front" %>
<div class="<%= class_names("container": !@is_mobile) %>"
     data-controller="toggle">
  <%# Removed Active Storage photo code - now using CarrierWave on User model for profile pictures %>

  <%= form_with model: @preference, method: @preference.id ? :patch : :post, multipart: true do |f| %>

    <div class="frame-color-shape frame-padding frame-margin-rl text-size box-scroller" >
      <div style="display: flex; align-items: center; gap: 10px;">
        <% if current_user.profile_picture.present? %>
          <%= image_tag(profile_picture_circular_url(current_user, 40), alt: 'Profile picture', id: "top_profile_picture", style: "width: 40px; height: 40px; border-radius: 50%; object-fit: cover;") %>
        <% else %>
          <img id="top_profile_picture" alt="Profile picture" style="display: none; width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" />
        <% end %>
        <b><%= render "shared/fullname", user: current_user %></b>
      </div>
      <br><br>

      <div class="row">
        <div class="col-4"><%= "ðŸŸï¸ Club:" %></div>
        <div class="col-3"><%= "#{current_user.club.name}" %></div>
      </div>
      <div class="row">
        <div class="col-4"><%= "ðŸ§© #{t(".role")}:" %></div>
        <div class="col-3"><%= "#{current_user.role.capitalize}" %></div>
      </div>

      <div class="row">
        <div class="col-4"><%= f.label :nickname, "ðŸ˜Ž #{t(".nickname")}:" %></div>
        <div class="col-2"><%= f.text_field :nickname,
                                placeholder: current_user.nickname,
                                value: current_user.nickname,
                                style: "width: 10em",
                                input_html: {class: "contact-field"} %>
        </div>
      </div>
      <div class="row">
        <div class="col-4"><%= f.label :first_name, "ðŸ‘¤ #{t(".first_name")}:" %></div>
        <div class="col-2"><%= f.text_field :first_name,
                                placeholder: current_user.first_name,
                                value: current_user.first_name,
                                style: "width: 10em",
                                input_html: {class: "contact-field"} %>
        </div>
      </div>
      <div class="row">
        <div class="col-4"><%= f.label :last_name, "ðŸ‘¤ #{t(".last_name")}:" %></div>
        <div class="col-2"><%= f.text_field :last_name,
                                placeholder: current_user.last_name,
                                value: current_user.last_name,
                                style: "width: 10em",
                                input_html: {class: "contact-field"} %>
        </div>
      </div>
      <div class="row">
        <div class="col-4"><%= f.label :phone_number, "ðŸ“ž #{t(".phone_number")} :" %></div>
        <div class="col-2"><%= f.text_field :phone_number,
                                placeholder: current_user.phone_number,
                                value: current_user.phone_number,
                                style: "width: 10em",
                                input_html: {class: "contact-field"} %>
        </div>
      </div>
      <div class="row">
        <div class="col-4"><%= f.label :e_mail, "ðŸ“© #{t(".e_mail")} :" %></div>
        <div class="col-2"><%= f.text_field :e_mail,
                                placeholder: current_user.email,
                                value: current_user.email,
                                style: "width: 20em",
                                input_html: {class: "contact-field"} %>
        </div>
      </div>
     <hr>

      <div class="row">
        <div class="col-4"><%= label_tag "user[profile_picture]", t(".profile_picture") %></div>
        <div class="col-4">
          <div class="custom-file-input-wrapper">
            <%= file_field_tag "user[profile_picture]", accept: "image/jpeg,image/jpg,image/png,image/gif,image/webp", class: "form-control custom-file-input", id: "profile_picture_input" %>
            <label for="profile_picture_input" class="custom-file-label btn btn-shape btn-beige">
              <%= t(".choose_file") %>
            </label>
          </div>
          <div id="profile_picture_preview" style="margin-top: 10px;">
            <% if current_user.profile_picture.present? %>
              <%= image_tag(current_user.profile_picture.url.to_s, alt: 'Profile picture', class: "rounded", style: "max-width: 100px; max-height: 100px;", id: "preview_image") %>
              <br><br>
            <% end %>
          </div>
        </div>
      </div>
      <script>
        (function() {
          function initProfilePicturePreview() {
            const fileInput = document.getElementById('profile_picture_input');
            const previewContainer = document.getElementById('profile_picture_preview');
            const topProfilePicture = document.getElementById('top_profile_picture');

            if (!fileInput || !previewContainer) {
              console.warn('Profile picture preview elements not found');
              return;
            }

            fileInput.addEventListener('change', function(e) {
              if (e.target.files && e.target.files.length > 0) {
                const file = e.target.files[0];

                // Validate file type
                if (!file.type.match('image.*')) {
                  console.warn('Selected file is not an image');
                  return;
                }

                const reader = new FileReader();

                reader.onload = function(event) {
                  const imageUrl = event.target.result;

                  // Update top circular profile picture
                  if (topProfilePicture) {
                    topProfilePicture.src = imageUrl;
                    topProfilePicture.style.display = 'block';
                  }

                  // Update or create preview image
                  let previewImg = previewContainer.querySelector('img');
                  if (previewImg) {
                    previewImg.src = imageUrl;
                  } else {
                    previewImg = document.createElement('img');
                    previewImg.src = imageUrl;
                    previewImg.alt = 'Profile picture preview';
                    previewImg.className = 'rounded';
                    previewImg.style.cssText = 'max-width: 100px; max-height: 100px;';
                    previewContainer.insertBefore(previewImg, previewContainer.firstChild);

                    // Add line breaks for spacing if they don't exist
                    if (!previewContainer.querySelector('br')) {
                      const br1 = document.createElement('br');
                      const br2 = document.createElement('br');
                      previewContainer.appendChild(br1);
                      previewContainer.appendChild(br2);
                    }
                  }
                };

                reader.onerror = function() {
                  console.error('Error reading file');
                };

                reader.readAsDataURL(file);
              }
            });
          }

          // Run immediately if DOM is ready, otherwise wait for DOMContentLoaded
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initProfilePicturePreview);
          } else {
            // DOM is already loaded, run immediately
            initProfilePicturePreview();
          }
        })();
      </script>


      <div class="row">
        <div class="col-4"><%= f.label :password, "ðŸ” #{t(".password")}:" %></div>
        <div class="col-8">
          <%= f.label :password, t(".modify_password") %>
          <%= check_box_tag(:password,"1", params[:password].eql?("1")) %>
        </div>
      </div>

      <% if (["player", "player referee"].include?(current_user.role)) %>
        <hr>
        <b><%= "League_Round - Box, #rank" %></b><br>
        <% name = "#{render "shared/fullname", user: current_user}"
          boxes = current_user.user_box_scores.map{ |ubs| "#{round_label(ubs.box.round)} - Box#{format('%02d', ubs.box.box_number)}, ##{ubs.rank},<br />" }.sort.join[0...-7] %>
        <%= sanitize "#{boxes}" %>
      <% end %>
      <hr>
      <b><%= t(".preferences") %></b><br>
        <%# checkbox to remove color gradient formatting if page does not display well on screen %>
        <%# check_box_tag(:clear_format,"1", params[:clear_format].eql?("1"), onchange: "this.form.submit();") %>
      <div class="row">
        <div class="col-4"><%= t(".expanded_view") %></div>
        <div class="col-5">
          <%= f.label :clear_format, t(".clear_format") %>
          <%= check_box_tag(:clear_format,"1", @preference.clear_format.eql?(true)) %>
        </div>
    </div>
    </div>
    <br>
    <div class = "buttons-wrap">
      <%= f.submit t(".submit_button"), class: "btn btn-shape btn-aqua" %>
    </div>
  <% end %>

</div>
